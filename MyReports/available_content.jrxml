<?xml version="1.0" encoding="UTF-8"?>
<!-- Created with Jaspersoft Studio version last-->
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="MiniReel Catalog" pageWidth="768" pageHeight="1024" columnWidth="728" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20" uuid="ea6e9ba7-f282-407d-b741-0e9231d2cc37">
	<property name="com.jaspersoft.studio.data.defaultdataadapter" value="deepthought"/>
	<property name="com.jaspersoft.studio.unit." value="pixel"/>
	<property name="ireport.jasperserver.url" value="http://jasper:8080/jasperserver/"/>
	<property name="ireport.jasperserver.report.resource" value="/Reports/MiniReel_Catalog_files/main_jrxml"/>
	<property name="ireport.jasperserver.reportUnit" value="/Reports/MiniReel_Catalog"/>
	<queryString language="SQL">
		<![CDATA[select o.name as content_publisher,
case when (u.fname is not null AND u.lname is not null) then u.fname || ' ' || u.lname else u.email end as editor,
u.email as editor_id,
u.user_type,m.title as minireel,m.experience_id as minireel_id,
v.category,
c.slide_count,
(c.has_ballots = 1)::boolean as has_survey,
coalesce(m.access_type,'private') as access_type,
'3/2' as splash_ratio,
'img-text-overlay' as splash_theme
from dim.user u
inner join dim.minireel m on m.created_by = u.user_id AND m.end_ts = u.end_ts
inner join (
	select minireel_key,max(case when ballot_prompt is null then 0 else 1 end) as has_ballots, count(card_id) as slide_count
	from dim.minireel_card
	group by minireel_key
	order by minireel_key
) c on c.minireel_key = m.minireel_key
left join (
	select minireel_key, category, category_count,rank() OVER (partition by minireel_key  order by category_count desc, category asc) as rank
	from (
		select c.minireel_key,v.category, count(v.category) as category_count
		from dim.minireel_card c
		left join dim.video v on c.video_client_id = v.video_client_id and v.end_ts = dim.sp_end_of_time()
		where c.video_client_id is not null
		group by c.minireel_key,v.category
	) as cats
	order by minireel_key,rank() OVER (partition by minireel_key  order by category_count desc)
) v on v.minireel_key = m.minireel_key AND v.rank = 1
inner join dim.org o on o.org_id = m.org_id AND o.end_ts = m.end_ts
where u.end_ts = dim.sp_end_of_time() and u.user_type = 'ContentProvider' and m.access_type = 'public' and m.status = 'active'
order by o.name,u.fname,m.title;]]>
	</queryString>
	<field name="content_publisher" class="java.lang.String"/>
	<field name="editor" class="java.lang.String"/>
	<field name="editor_id" class="java.lang.String"/>
	<field name="user_type" class="java.lang.String">
		<fieldDescription><![CDATA[Type of user - Publisher, ContentProvider, etc.]]></fieldDescription>
	</field>
	<field name="minireel" class="java.lang.String"/>
	<field name="minireel_id" class="java.lang.String"/>
	<field name="access_type" class="java.lang.String">
		<fieldDescription><![CDATA[Access enabled for the MiniReel (public/private).]]></fieldDescription>
	</field>
	<field name="splash_theme" class="java.lang.String">
		<fieldDescription><![CDATA[Theme used to design the splash.]]></fieldDescription>
	</field>
	<field name="slide_count" class="java.lang.Long"/>
	<field name="has_survey" class="java.lang.Boolean"/>
	<field name="splash_ratio" class="java.lang.String">
		<fieldDescription><![CDATA[Ratio used for sizing the image.]]></fieldDescription>
	</field>
	<field name="category" class="java.lang.String">
		<fieldDescription><![CDATA[Category of permission (elections,experiences,etc.).]]></fieldDescription>
	</field>
	<group name="content_publisher">
		<groupExpression><![CDATA[$F{content_publisher}]]></groupExpression>
	</group>
	<group name="editor">
		<groupExpression><![CDATA[$F{editor}]]></groupExpression>
		<groupHeader>
			<band height="53">
				<property name="local_mesure_unitheight" value="pixel"/>
				<property name="com.jaspersoft.studio.unit.height" value="px"/>
				<textField>
					<reportElement mode="Opaque" x="30" y="15" width="660" height="30" backcolor="#F5F5F5" uuid="9e522491-68ee-447e-8986-3f5dfdc6f5f9">
						<property name="local_mesure_unitheight" value="pixel"/>
						<property name="com.jaspersoft.studio.unit.height" value="px"/>
					</reportElement>
					<box leftPadding="12"/>
					<textElement verticalAlignment="Middle">
						<font size="14" isBold="true"/>
					</textElement>
					<textFieldExpression><![CDATA[$F{content_publisher} + ", " + $F{editor}]]></textFieldExpression>
				</textField>
			</band>
		</groupHeader>
	</group>
	<title>
		<band height="83" splitType="Stretch">
			<staticText>
				<reportElement x="30" y="40" width="610" height="40" uuid="e757682a-0f90-495e-b239-5b4823c8856f"/>
				<textElement verticalAlignment="Top">
					<font size="20" isBold="true"/>
				</textElement>
				<text><![CDATA[MiniReel Catalog]]></text>
			</staticText>
		</band>
	</title>
	<columnHeader>
		<band height="35" splitType="Stretch">
			<property name="local_mesure_unitheight" value="pixel"/>
			<property name="com.jaspersoft.studio.unit.height" value="px"/>
			<staticText>
				<reportElement x="30" y="0" width="350" height="30" uuid="c6188e58-3f3d-4d8c-b4a3-64e29aec4db2">
					<property name="local_mesure_unitheight" value="pixel"/>
					<property name="com.jaspersoft.studio.unit.height" value="px"/>
					<property name="local_mesure_unity" value="pixel"/>
					<property name="com.jaspersoft.studio.unit.y" value="px"/>
				</reportElement>
				<box>
					<bottomPen lineWidth="2.0"/>
				</box>
				<textElement verticalAlignment="Middle">
					<font size="12"/>
				</textElement>
				<text><![CDATA[Title]]></text>
			</staticText>
			<staticText>
				<reportElement x="520" y="0" width="40" height="30" uuid="79084894-100d-4b3b-be57-c48b97c9ad0c">
					<property name="local_mesure_unitwidth" value="pixel"/>
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<box>
					<bottomPen lineWidth="2.0"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="12"/>
				</textElement>
				<text><![CDATA[Slides]]></text>
			</staticText>
			<staticText>
				<reportElement x="578" y="0" width="55" height="30" uuid="4516fba1-319c-4577-97e7-1389d5fba838">
					<property name="local_mesure_unitwidth" value="pixel"/>
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<box>
					<bottomPen lineWidth="2.0"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="12"/>
				</textElement>
				<text><![CDATA[Survey]]></text>
			</staticText>
			<staticText>
				<reportElement x="390" y="0" width="120" height="30" uuid="389d5980-4b83-4573-a70e-8bcb7b3345b1">
					<property name="local_mesure_unitheight" value="pixel"/>
					<property name="com.jaspersoft.studio.unit.height" value="px"/>
				</reportElement>
				<box>
					<bottomPen lineWidth="2.0"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="12"/>
				</textElement>
				<text><![CDATA[Category]]></text>
			</staticText>
		</band>
	</columnHeader>
	<detail>
		<band height="28" splitType="Stretch">
			<property name="local_mesure_unitheight" value="pixel"/>
			<property name="com.jaspersoft.studio.unit.height" value="px"/>
			<textField>
				<reportElement x="31" y="0" width="349" height="28" uuid="3b5476b4-6a98-416b-9d22-1c2e0c80ee06">
					<property name="local_mesure_unitheight" value="pixel"/>
					<property name="com.jaspersoft.studio.unit.height" value="px"/>
				</reportElement>
				<textElement verticalAlignment="Middle">
					<font size="12"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{minireel}]]></textFieldExpression>
			</textField>
			<textField pattern="#,###">
				<reportElement x="520" y="0" width="40" height="28" uuid="a7bc7ef4-61bc-4175-b69d-2f02a602c038">
					<property name="local_mesure_unitwidth" value="pixel"/>
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="12"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{slide_count}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="585" y="0" width="40" height="28" uuid="3aa20309-c2f0-4814-a830-f81003d78f70">
					<property name="local_mesure_unitwidth" value="pixel"/>
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="12"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{has_survey} ? "Y" : ""]]></textFieldExpression>
			</textField>
			<textField hyperlinkType="Reference" hyperlinkTarget="Blank">
				<reportElement x="640" y="0" width="50" height="28" forecolor="#3300FF" uuid="fa419b8a-8255-4add-9a99-27f995a88052"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="12" isUnderline="true"/>
				</textElement>
				<textFieldExpression><![CDATA["Preview"]]></textFieldExpression>
				<hyperlinkReferenceExpression><![CDATA["http://www.cinema6.com/preview/minireel?exp=" + $F{minireel_id} + "&title=" + java.net.URLEncoder.encode($F{minireel},"UTF-8").replaceAll("\\+","%20") + "&splash=" + $F{splash_theme} + ":" + $F{splash_ratio} + "&preload"]]></hyperlinkReferenceExpression>
			</textField>
			<textField>
				<reportElement x="400" y="0" width="110" height="28" uuid="b830cbff-35a9-4f4e-9bc0-f532f9a2dc9b">
					<property name="local_mesure_unitheight" value="pixel"/>
					<property name="com.jaspersoft.studio.unit.height" value="px"/>
				</reportElement>
				<textElement textAlignment="Left" verticalAlignment="Middle">
					<font size="12"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{category}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
</jasperReport>
